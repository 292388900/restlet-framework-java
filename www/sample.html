<html>
<head>
 <style type="text/css">
/* <![CDATA[ */
@import "http://www.restlet.org/stylesheets/tigris.css";
/*  ]]> */
 </style>
 <title>Restlet - Sample application</title>
</head>
<body>

<a target="_top" href="http://www.restlet.org"><img src="http://www.restlet.org/images/logo200"/></a><br/>

<br/>

<h1>Sample application</h1>
<br/>

<h3><a name="toc">Table of contents</a></h3>
<p>
   <ol>
      <li><a href="#part01">Introduction</a></li>
      <li><a href="#part02">Imported classes</a></li>
      <li><a href="#part03">Declaring the Main class</a></li>
      <li><a href="#part04">Main method</a></li>
      <li><a href="#part05">Member variables</a></li>
      <li><a href="#part06">Constructor method</a></li>
      <li><a href="#part07">RootMaplet inner class</a></li>
      <li><a href="#part08">Static addExtensions method</a></li>
      <li><a href="#part09">Conclusion</a></li>
   </ol>
</p>
<br/>

<h3><a name="part01">1. Introduction</a></h3>
<p>
   The Restlet Web site that you are currently navigating is powered by the Noelios Restlet Engine, the reference implementation of the Restlet API. In order to serve HTTP calls, we rely on a production-ready Jetty 5.1 HTTP connector. As you will see below, running basic Web sites with Restlets is straightforward. The required code consists of less than 200 lines of Java code, including comments.
</p>
<br/>

<h3><a name="part02">2. Imported classes</a></h3>
<p>
   First, let's declare the imported classes required to support our Web container.
</p>
<pre>
      import java.io.File;

      import org.restlet.Call;
      import org.restlet.DefaultMaplet;
      import org.restlet.component.RestletContainer;
      import org.restlet.connector.GenericServer;
      import org.restlet.data.ChallengeSchemes;
      import org.restlet.data.Languages;
      import org.restlet.data.MediaTypes;
      import org.restlet.data.Protocols;

      import com.noelios.restlet.DirectoryRestlet;
      import com.noelios.restlet.GuardChainlet;
      import com.noelios.restlet.LogChainlet;
      import com.noelios.restlet.RedirectRestlet;
      import com.noelios.restlet.StatusChainlet;
      import com.noelios.restlet.util.StringUtils;
</pre>
<br/>

<h3><a name="part03">3. Declaring the Main class</a></h3>
<p>
   Now, we declare the main class, called the WebContainer, extending the org.restlet.component.DefaultRestletContainer. Note that this container hosts two Web servers, one for the Restlet project and one for the Noelios Consulting Web site. For more complex Web sites we could perfectly use two Restlet Containers, one for each Web site, all contained with a root Restlet Server.
</p>
<pre>
      /**
       * The web server hosting the Restlet and Noelios Consulting Web servers.<br/>
       * One server connector is listening to the noelios.com domain.<br/>
       * Another connector is listening to the restlet.com, restlet.org and restlet.net domains.
       */
      public class WebContainer extends RestletContainer
      {
         ...
</pre>
<br/>

<h3><a name="part04">4. Main method</a></h3>
<p>
   Below, you have the main method that is invoked by our startup scripts. Note that we take arguments in order to parameterize several aspects like IP addresses and listening ports. Each Web site (Restlet and Noelios Consulting) uses a separate IP address and TCP port combination. You will understand later how we support multiple virtual hosts at the same time.
</p>
<pre>
      /**
       * Main method.
       * @param args Program arguments.
       */
      public static void main(String[] args)
      {
         if((args == null) || (args.length != 7))
         {
            System.err.println(
                  "Can't launch the Maine web server. List of required arguments:\n" +
                  " 1) Restlet root path   (where web files are located)\n" +
                  " 2) Restlet IP address  (local IP address to listen on)\n" +
                  " 3) Restlet port number (local port to listen on)\n" +
                  " 4) Noelios root path   (where web files are located)\n" +
                  " 5) Noelios IP address  (local IP address to listen on)\n" +
                  " 6) Noelios port number (local port to listen on)\n" +
                  " 7) Data root path      (where stable data files are located)");
         }
         else
         {
            try
            {
               // Create an start the server
               new WebContainer(args[0], args[1], Integer.parseInt(args[2]), args[3], args[4], Integer.parseInt(args[5]), args[6]).start();
            }
            catch(Exception e)
            {
               System.err.println("Can't launch the Web server.\nAn unexpected exception occured:");
               e.printStackTrace(System.err);
            }
         }
      }
</pre>
<br/>

<h3><a name="part05">5. Member variables</a></h3>
<p>
   As we will declare an inner Maplet class, we need to store some arguments in member variables.
</p>
<pre>
      /** Member variables. */
      private String noeliosPath;
      private int noeliosPort;
      private String restletPath;
      private int restletPort;
      private String dataPath;
</pre>
<br/>

<h3><a name="part06">6. Constructor method</a></h3>
<p>
   After saving some arguments as member variables, we will initialize the logging mechanism by specifying the location of our properties file (standard java.util.logging practice). Then, we create two server HTTP connectors (one for each Web site) that we attach to the Restlet container using the addServer() method. Then, we create a LogChainlet to write all calls into Apache-like log files, we chain a typical StatusChainlet and a Maplet to it. Note that all the Chainlet instances and the RootMaplet instance are shared by all client calls. In fact, multiple concurrent threads can execute the same code in parallel.
</p>
<pre>
      /**
       * Constructor.
       * @param restletPath Path where the Restlet web files are located.
       * @param restletAddress Local IP address to listen on.
       * @param restletPort Local port address to listen on.
       * @param noeliosPath Path where the Noelios web files are located.
       * @param noeliosAddress Local IP address to listen on.
       * @param noeliosPort Local port address to listen on.
       * @param dataPath Path where data files are located.
       */
      public WebContainer(String restletPath, String restletAddress, int restletPort,
                          String noeliosPath, String noeliosAddress, int noeliosPort,
                          String dataPath)
      {
         super("Maine web server");
         this.restletPath = restletPath;
         this.restletPort = restletPort;
         this.noeliosPath = noeliosPath;
         this.noeliosPort = noeliosPort;
         this.dataPath = StringUtils.normalizePath(dataPath);

         // Create the HTTP server connector for the Restlet domains
         addServer(new GenericServer(Protocols.HTTP, "Restlet HTTP server", this, restletAddress, restletPort));

         // Create the HTTP server connector for the Noelios domain
         addServer(new GenericServer(Protocols.HTTP, "Noelios HTTP server", this, noeliosAddress, noeliosPort));

         // Attach the logger Chainlet
         LogChainlet logger = new LogChainlet(this, "com.noelios.maine.WebContainer.www");
         attach("http://", logger);

         // Attach the status Chainlet
         StatusChainlet status = new StatusChainlet(this, false, "contact@noelios.com", "http://www.noelios.com");
         logger.attach(status);

         // Attach the root Maplet to the logger
         status.attach(new RootMaplet(this));
      }
</pre>
<br/>

<h3><a name="part07">7. RootMaplet inner class</a></h3>
<p>
   The root maplet is the main responsible for the dispatching of the client calls to the proper handler. First, let's see an overview of the call handling flow:
</p>
<p>
   <img src="images/sample01" alt="Call handling flow"/><br/>
</p>
<p>
   You see on the left the two Jetty connectors listening to separate IP addresses. They share two chainlets and the root maplet that we will see in details below. The "restletDir" was mapped to the "http://www.restlet.org" URI and will serve the static file from a given directory. The "restletRedirect" will permanently redirect clients from the side domains (restlet.com, restlet.net) to the proper "www.restlet.org" server in order to force the clients to use consistent URIs. We also have "noeliosDir" and "noeliosRedirect" Restlets behaving similarly for the Noelios Consulting domain. Finally, there is an interesting "blogRedirect" based on the RedirectRestlet which will temporarily redirect the clients from "http://blog.noelios.com/*" to "http://noelios.wordpress.com/*" while keeping the rest of the URI intact, including any query parameter. Finally, a "downloadsDir" was added recently to server the files under "http://www.restlet.org/donwloads" from a different location.
</p>
<pre>
      /**
       * Root Maplet dispatching the call to the correct final handler.
       * Handles virtual domains naturally.
       */
      class RootMaplet extends DefaultMaplet
      {
         /**
          * Constructor.
          * @param container The parent Restlet container.
          */
         public RootMaplet(SampleContainer container)
         {
            super(container);

            // Map URIs for the Restlet domains
            String defaultPattern = "${path}${if query}?${query}${end}";
            String portPath = (restletPort == 80) ? "" : (":" + restletPort);
            String rootUri = "www.restlet.org" + portPath;

            // Create the directory Restlet
            DirectoryRestlet restletDir = new DirectoryRestlet(container, restletPath, true, "index");
            addExtensions(restletDir);

            // Create the downloads directory Restlet
            String downloadsPath = dataPath + File.separatorChar + "archive" + File.separatorChar + "restlet";
            DirectoryRestlet downloadsDir = new DirectoryRestlet(container, downloadsPath, true, "index");
            downloadsDir.addExtension("zip", MediaTypes.APPLICATION_ZIP);

            // Create the redirect Restlet
            String targetPattern = "http://www.restlet.org" + defaultPattern;
            RedirectRestlet restletRedirect = new RedirectRestlet(container, targetPattern, RedirectRestlet.MODE_CLIENT_PERMANENT);

            // Attach as root Restlets
            attach(rootUri + "/downloads", downloadsDir);
            attach(rootUri, restletDir);
            attach("restlet.com" + portPath, restletRedirect);
            attach("www.restlet.com" + portPath, restletRedirect);
            attach("restlet.net" + portPath, restletRedirect);
            attach("www.restlet.net" + portPath, restletRedirect);
            attach("restlet.org" + portPath, restletRedirect);

            // Map URIs for the Noelios domain
            portPath = (container.noeliosPort == 80) ? "" : (":" + noeliosPort);
            rootUri = "www.noelios.com" + portPath;

            // Create the directory Restlet
            DirectoryRestlet noeliosDir = new DirectoryRestlet(container, noeliosPath, true, "index");
            addExtensions(noeliosDir);

            // Create the redirection Restlets
            targetPattern = "http://www.noelios.com" + defaultPattern;
            RedirectRestlet noeliosRedirect = new RedirectRestlet(container, targetPattern, RedirectRestlet.MODE_CLIENT_PERMANENT);
            targetPattern = "http://noelios.wordpress.com" + defaultPattern;
            RedirectRestlet blogRedirect = new RedirectRestlet(container, targetPattern, RedirectRestlet.MODE_CLIENT_TEMPORARY);

            // Attach as root Restlets
            attach(rootUri, noeliosDir);
            attach("blog.noelios.com" + portPath, blogRedirect);
            attach("noelios.com" + portPath, noeliosRedirect);
         }
      }
</pre>

<h3><a name="part08">8. Static addExtensions method</a></h3>
<p>
   We centralize the association of file extensions to metadata in this static method. Note that we use the same mechanism to associate languages or MIME media types. Therefore you can have in the same directory multiple variants like "index.fr.html", "index.fr.pdf", "index.en.txt", etc. The Noelios Restlet Engine will do its best to negotiate the best representation for the "index" resource based on the client preferences, see the <a href="http://www.restlet.org/docs/api/org/restlet/RestletCall.html#setBestOutput(org.restlet.Resource)">RestletCall.setBestOutput()</a> method for details.
</p>
<pre>
      /**
       * Adds a common list of extensions to a directory Restlet.
       * @param dir The directory Restlet to update.
       */
      public static void addExtensions(DirectoryRestlet dir)
      {
         dir.addExtension("en",   Languages.ENGLISH_US);
         dir.addExtension("fr",   Languages.FRENCH_FRANCE);
         dir.addExtension("html", MediaTypes.TEXT_HTML);
         dir.addExtension("css",  MediaTypes.TEXT_CSS);
         dir.addExtension("doc",  MediaTypes.APPLICATION_WORD);
         dir.addExtension("gif",  MediaTypes.IMAGE_GIF);
         dir.addExtension("ico",  MediaTypes.IMAGE_ICON);
         dir.addExtension("pdf",  MediaTypes.APPLICATION_PDF);
         dir.addExtension("png",  MediaTypes.IMAGE_PNG);
         dir.addExtension("txt",  MediaTypes.TEXT_PLAIN);
         dir.addExtension("zip",  MediaTypes.APPLICATION_ZIP);
      }
</pre>
<br/>

<h3><a name="part09">9. Conclusion</a></h3>
<p>
   That's all! Beside the standard logging properties, no additional XML configuration is required. Feel free to copy this sample source code in order to run your own Web sites.
</p>
<br/>

<p>
   <a href="mailto:contact@noelios.com">J&eacute;r&ocirc;me Louvel</a> (<a target="_top" href="http://blog.noelios.com">blog</a>)<br/>
</p>

<h4>Notes</h4>
<p>
   <ul>
      <li>Thanks to Michael Mayer for the idea of providing the source code of this Web site as a sample application.</li>
   </ul>
</p>

<br/>

<small>
   Version 1.5, last modified on 2006/05/01<br/>
   Copyright &copy; 2005-2006 <a href="mailto:contact@noelios.com">J&eacute;r&ocirc;me Louvel</a>. Restlet is a registered trademark of <a target="_top" href="http://www.noelios.com">Noelios Consulting</a>.
</small>

</body>
</html>
